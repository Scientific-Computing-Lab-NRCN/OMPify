from subprocess import Popen, PIPE
from datetime import date, timedelta
from dateutil.relativedelta import relativedelta

SCRIPT_PATH = '/home/talkad/Downloads/thesis/data_gathering_script/git_clone/git_clone.sh'

def load(start_date=None, end_date=None, is_dry=False):
	'''
	Load repositories created in range of dates from github that include omp directives

	Parameters:
		start_date - lower bound of dates
		end_date   - upper bound of dates
		is_dry     - whether to load the files or not
	'''
	
	month = 30
	max_results = 10**3
	start_date = date(2012, 1, 1) if start_date is None else start_date
	end_date = date.today() if end_date is None else end_date
	total_repos = 0
	repos_per_month = {}

	while start_date <= end_date:
		start = start_date.strftime("%Y-%m-%d")
		delta = relativedelta(days=month)
		end = (start_date + delta).strftime("%Y-%m-%d")

		# exectue the "dry" version
		p = Popen([SCRIPT_PATH, "y", start, end], stdin=PIPE, stdout=PIPE, stderr=PIPE)
		output, err = p.communicate()

		num_results = 0 if len(output) == 0 else len(output.split(b"\ndry-run:"))
		# print(output.split(b"\ndry-run:"))
		# break

		if num_results < max_results:
			#clone
			if not is_dry:
				p = Popen([SCRIPT_PATH, "", start, end], stdin=PIPE, stdout=PIPE, stderr=PIPE)
				output, err = p.communicate()
				
			print(f'cloned {num_results} repos from {start} to {end}')
			repos_per_month[f'{start_date.month}-{start_date.year}'] = num_results

			month = 30
			total_repos += num_results
			start_date += delta
		else:
			month = month // 2

	print(f'total number of repos cloned: {total_repos}')	
	return repos_per_month	

# print(load(is_dry=True))

# openMP
# {'1-2008': 1, '2-2008': 1, '3-2008': 1, '4-2008': 1, '5-2008': 1, '6-2008': 1, '7-2008': 1, '8-2008': 1, '9-2008': 1, '10-2008': 1, '11-2008': 1, '12-2008': 1, '1-2009': 1, '2-2009': 1, '3-2009': 1, '4-2009': 1, '5-2009': 1, '6-2009': 1, '7-2009': 1, '8-2009': 1, '9-2009': 1, '10-2009': 1, '11-2009': 1, '12-2009': 1, '1-2010': 1, '2-2010': 1, '3-2010': 1, '4-2010': 1, '5-2010': 1, '6-2010': 1, '7-2010': 1, '8-2010': 1, '9-2010': 3, '10-2010': 3, '11-2010': 2, '12-2010': 1, '1-2011': 3, '2-2011': 1, '3-2011': 1, '4-2011': 1, '5-2011': 3, '6-2011': 6, '7-2011': 1, '8-2011': 2, '9-2011': 1, '10-2011': 3, '11-2011': 1, '12-2011': 8, '1-2012': 1, '2-2012': 9, '3-2012': 5, '4-2012': 9, '5-2012': 4, '6-2012': 4, '7-2012': 6, '8-2012': 6, '9-2012': 10, '10-2012': 11, '11-2012': 14, '12-2012': 6, '1-2013': 5, '2-2013': 13, '3-2013': 18, '4-2013': 17, '5-2013': 8, '6-2013': 9, '7-2013': 14, '8-2013': 12, '9-2013': 9, '10-2013': 23, '11-2013': 22, '12-2013': 26, '1-2014': 25, '2-2014': 16, '3-2014': 29, '4-2014': 29, '5-2014': 24, '6-2014': 22, '7-2014': 26, '8-2014': 16, '9-2014': 27, '10-2014': 27, '11-2014': 31, '12-2014': 27, '1-2015': 38, '2-2015': 29, '3-2015': 50, '4-2015': 38, '5-2015': 37, '6-2015': 32, '7-2015': 26, '8-2015': 34, '9-2015': 41, '10-2015': 59, '11-2015': 54, '12-2015': 45, '1-2016': 36, '2-2016': 51, '3-2016': 66, '4-2016': 56, '5-2016': 59, '6-2016': 41, '7-2016': 32, '8-2016': 28, '9-2016': 50, '10-2016': 76, '11-2016': 83, '12-2016': 53, '1-2017': 65, '2-2017': 70, '3-2017': 122, '4-2017': 89, '5-2017': 89, '6-2017': 61, '7-2017': 72, '8-2017': 60, '9-2017': 71, '10-2017': 117, '11-2017': 96, '12-2017': 98, '1-2018': 60, '2-2018': 96, '3-2018': 116, '4-2018': 110, '5-2018': 114, '6-2018': 77, '7-2018': 71, '8-2018': 69, '9-2018': 82, '10-2018': 118, '11-2018': 93, '12-2018': 91, '1-2019': 105, '2-2019': 113, '3-2019': 147, '4-2019': 135, '5-2019': 119, '6-2019': 97, '7-2019': 75, '8-2019': 73, '9-2019': 90, '10-2019': 140, '11-2019': 124, '12-2019': 121, '1-2020': 91, '2-2020': 92, '3-2020': 102, '4-2020': 152, '5-2020': 141, '6-2020': 110, '7-2020': 90, '8-2020': 78, '9-2020': 107, '10-2020': 141, '11-2020': 135, '12-2020': 125, '1-2021': 110, '2-2021': 99, '3-2021': 113, '4-2021': 116, '5-2021': 121, '6-2021': 87, '7-2021': 70, '8-2021': 97, '9-2021': 93, '10-2021': 91, '11-2021': 148, '12-2021': 120, '1-2022': 94, '2-2022': 71, '3-2022': 117, '4-2022': 134, '5-2022': 159, '6-2022': 101, '7-2022': 99, '8-2022': 48}
# total: 8644


# mpi + X
# {'1-2012': 3, '3-2012': 4, '4-2012': 0, '5-2012': 0, '6-2012': 2, '7-2012': 1, '8-2012': 3, '9-2012': 2, '10-2012': 4, '11-2012': 1, '12-2012': 1, '1-2013': 2, '2-2013': 3, '3-2013': 4, '4-2013': 4, '5-2013': 1, '6-2013': 3, '7-2013': 3, '8-2013': 3, '9-2013': 10, '10-2013': 7, '11-2013': 5, '12-2013': 4, '1-2014': 3, '2-2014': 8, '3-2014': 6, '4-2014': 6, '5-2014': 4, '6-2014': 9, '7-2014': 9, '8-2014': 12, '9-2014': 4, '10-2014': 10, '11-2014': 5, '12-2014': 8, '1-2015': 14, '2-2015': 11, '3-2015': 12, '4-2015': 6, '5-2015': 9, '6-2015': 3, '7-2015': 8, '8-2015': 7, '9-2015': 11, '10-2015': 15, '11-2015': 11, '12-2015': 11, '1-2016': 11, '2-2016': 15, '3-2016': 16, '4-2016': 14, '5-2016': 10, '6-2016': 9, '7-2016': 8, '8-2016': 3, '9-2016': 15, '10-2016': 15, '11-2016': 23, '12-2016': 15, '1-2017': 21, '2-2017': 24, '3-2017': 36, '4-2017': 22, '5-2017': 19, '6-2017': 18, '7-2017': 12, '8-2017': 13, '9-2017': 8, '10-2017': 15, '11-2017': 26, '12-2017': 15, '1-2018': 24, '2-2018': 29, '3-2018': 22, '4-2018': 21, '5-2018': 17, '6-2018': 19, '7-2018': 13, '8-2018': 17, '9-2018': 28, '10-2018': 29, '11-2018': 28, '12-2018': 22, '1-2019': 30, '2-2019': 40, '3-2019': 26, '4-2019': 27, '5-2019': 22, '6-2019': 20, '7-2019': 21, '8-2019': 24, '9-2019': 17, '10-2019': 26, '11-2019': 29, '12-2019': 24, '1-2020': 16, '2-2020': 32, '3-2020': 23, '4-2020': 27, '5-2020': 41, '6-2020': 18, '7-2020': 20, '8-2020': 18, '9-2020': 31, '10-2020': 26, '11-2020': 27, '12-2020': 20, '1-2021': 24, '2-2021': 28, '3-2021': 25, '4-2021': 19, '5-2021': 28, '6-2021': 22, '7-2021': 24, '8-2021': 23, '9-2021': 26, '10-2021': 26, '11-2021': 29, '12-2021': 29, '1-2022': 33, '2-2022': 22, '3-2022': 26, '4-2022': 32, '5-2022': 39, '6-2022': 25, '7-2022': 13, '8-2022': 13, '9-2022': 17, '10-2022': 23, '11-2022': 25, '12-2022': 6}
# total: 2106


# cuda
# {'1-2012': 19, '3-2012': 36, '4-2012': 33, '5-2012': 32, '6-2012': 22, '7-2012': 20, '8-2012': 38, '9-2012': 25, '10-2012': 25, '11-2012': 34, '12-2012': 44, '1-2013': 63, '2-2013': 53, '3-2013': 60, '4-2013': 51, '5-2013': 43, '6-2013': 50, '7-2013': 35, '8-2013': 41, '9-2013': 51, '10-2013': 84, '11-2013': 63, '12-2013': 82, '1-2014': 83, '2-2014': 88, '3-2014': 90, '4-2014': 92, '5-2014': 80, '6-2014': 72, '7-2014': 75, '8-2014': 77, '9-2014': 80, '10-2014': 86, '11-2014': 117, '12-2014': 82, '1-2015': 96, '2-2015': 168, '3-2015': 234, '4-2015': 220, '5-2015': 170, '6-2015': 165, '7-2015': 128, '8-2015': 149, '9-2015': 163, '10-2015': 160, '11-2015': 214, '12-2015': 124, '1-2016': 190, '2-2016': 278, '3-2016': 235, '4-2016': 219, '5-2016': 201, '6-2016': 152, '7-2016': 140, '8-2016': 131, '9-2016': 208, '10-2016': 273, '11-2016': 225, '12-2016': 213, '1-2017': 212, '2-2017': 282, '3-2017': 253, '4-2017': 257, '5-2017': 263, '6-2017': 600, '7-2017': 213, '8-2017': 205, '9-2017': 215, '10-2017': 322, '11-2017': 265, '12-2017': 265, '1-2018': 272, '2-2018': 325, '3-2018': 319, '4-2018': 332, '5-2018': 271, '6-2018': 260, '7-2018': 242, '8-2018': 290, '9-2018': 295, '10-2018': 344, '11-2018': 332, '12-2018': 320, '1-2019': 330, '2-2019': 341, '3-2019': 383, '4-2019': 348, '5-2019': 319, '6-2019': 316, '7-2019': 294, '8-2019': 289, '9-2019': 349, '10-2019': 366, '11-2019': 421, '12-2019': 310, '1-2020': 318, '2-2020': 363, '3-2020': 376, '4-2020': 382, '5-2020': 368, '6-2020': 346, '7-2020': 352, '8-2020': 344, '9-2020': 386, '10-2020': 443, '11-2020': 429, '12-2020': 405, '1-2021': 411, '2-2021': 440, '3-2021': 415, '4-2021': 469, '5-2021': 409, '6-2021': 335, '7-2021': 314, '8-2021': 296, '9-2021': 346, '10-2021': 374, '11-2021': 437, '12-2021': 339, '1-2022': 413, '2-2022': 324, '3-2022': 349, '4-2022': 354, '5-2022': 394, '6-2022': 394, '7-2022': 324, '8-2022': 325, '9-2022': 347, '10-2022': 311, '11-2022': 396, '12-2022': 144}
# total: 30958


# openACC
# {'1-2012': 0, '3-2012': 0, '4-2012': 0, '5-2012': 0, '6-2012': 0, '7-2012': 0, '8-2012': 2, '9-2012': 2, '10-2012': 0, '11-2012': 0, '12-2012': 1, '1-2013': 1, '2-2013': 3, '3-2013': 3, '4-2013': 2, '5-2013': 3, '6-2013': 6, '7-2013': 2, '8-2013': 2, '9-2013': 3, '10-2013': 8, '11-2013': 3, '12-2013': 1, '1-2014': 1, '2-2014': 4, '3-2014': 1, '4-2014': 3, '5-2014': 1, '6-2014': 2, '7-2014': 1, '8-2014': 6, '9-2014': 1, '10-2014': 3, '11-2014': 3, '12-2014': 5, '1-2015': 3, '2-2015': 5, '3-2015': 3, '4-2015': 1, '5-2015': 4, '6-2015': 4, '7-2015': 5, '8-2015': 2, '9-2015': 2, '10-2015': 5, '11-2015': 6, '12-2015': 6, '1-2016': 4, '2-2016': 5, '3-2016': 8, '4-2016': 5, '5-2016': 4, '6-2016': 5, '7-2016': 7, '8-2016': 2, '9-2016': 6, '10-2016': 1, '11-2016': 5, '12-2016': 0, '1-2017': 8, '2-2017': 6, '3-2017': 3, '4-2017': 2, '5-2017': 2, '6-2017': 4, '7-2017': 7, '8-2017': 11, '9-2017': 6, '10-2017': 4, '11-2017': 8, '12-2017': 4, '1-2018': 7, '2-2018': 8, '3-2018': 11, '4-2018': 6, '5-2018': 4, '6-2018': 7, '7-2018': 3, '8-2018': 1, '9-2018': 4, '10-2018': 5, '11-2018': 2, '12-2018': 4, '1-2019': 4, '2-2019': 10, '3-2019': 5, '4-2019': 9, '5-2019': 4, '6-2019': 7, '7-2019': 4, '8-2019': 5, '9-2019': 7, '10-2019': 6, '11-2019': 8, '12-2019': 4, '1-2020': 10, '2-2020': 7, '3-2020': 7, '4-2020': 7, '5-2020': 10, '6-2020': 8, '7-2020': 2, '8-2020': 12, '9-2020': 5, '10-2020': 6, '11-2020': 7, '12-2020': 8, '1-2021': 3, '2-2021': 7, '3-2021': 6, '4-2021': 6, '5-2021': 13, '6-2021': 8, '7-2021': 8, '8-2021': 3, '9-2021': 10, '10-2021': 3, '11-2021': 13, '12-2021': 4, '1-2022': 3, '2-2022': 4, '3-2022': 11, '4-2022': 4, '5-2022': 5, '6-2022': 9, '7-2022': 6, '8-2022': 10, '9-2022': 13, '10-2022': 6, '11-2022': 9, '12-2022': 3}
# total: 634


# openCL
# {'1-2012': 19, '3-2012': 19, '4-2012': 27, '5-2012': 22, '6-2012': 28, '7-2012': 26, '8-2012': 27, '9-2012': 26, '10-2012': 26, '11-2012': 39, '12-2012': 25, '1-2013': 23, '2-2013': 35, '3-2013': 25, '4-2013': 35, '5-2013': 31, '6-2013': 23, '7-2013': 31, '8-2013': 40, '9-2013': 29, '10-2013': 34, '11-2013': 43, '12-2013': 43, '1-2014': 56, '2-2014': 53, '3-2014': 39, '4-2014': 57, '5-2014': 45, '6-2014': 41, '7-2014': 48, '8-2014': 46, '9-2014': 60, '10-2014': 43, '11-2014': 61, '12-2014': 61, '1-2015': 59, '2-2015': 75, '3-2015': 95, '4-2015': 83, '5-2015': 103, '6-2015': 82, '7-2015': 91, '8-2015': 99, '9-2015': 70, '10-2015': 101, '11-2015': 97, '12-2015': 71, '1-2016': 91, '2-2016': 77, '3-2016': 69, '4-2016': 87, '5-2016': 61, '6-2016': 69, '7-2016': 76, '8-2016': 72, '9-2016': 82, '10-2016': 81, '11-2016': 120, '12-2016': 71, '1-2017': 90, '2-2017': 109, '3-2017': 135, '4-2017': 118, '5-2017': 107, '6-2017': 95, '7-2017': 96, '8-2017': 75, '9-2017': 90, '10-2017': 100, '11-2017': 84, '12-2017': 106, '1-2018': 135, '2-2018': 136, '3-2018': 156, '4-2018': 145, '5-2018': 144, '6-2018': 101, '7-2018': 87, '8-2018': 129, '9-2018': 135, '10-2018': 146, '11-2018': 138, '12-2018': 140, '1-2019': 165, '2-2019': 126, '3-2019': 193, '4-2019': 140, '5-2019': 147, '6-2019': 155, '7-2019': 137, '8-2019': 166, '9-2019': 215, '10-2019': 200, '11-2019': 192, '12-2019': 141, '1-2020': 202, '2-2020': 209, '3-2020': 248, '4-2020': 202, '5-2020': 208, '6-2020': 180, '7-2020': 228, '8-2020': 217, '9-2020': 246, '10-2020': 273, '11-2020': 293, '12-2020': 298, '1-2021': 291, '2-2021': 309, '3-2021': 399, '4-2021': 446, '5-2021': 395, '6-2021': 349, '7-2021': 331, '8-2021': 286, '9-2021': 351, '10-2021': 328, '11-2021': 362, '12-2021': 339, '1-2022': 452, '2-2022': 408, '3-2022': 478, '4-2022': 435, '5-2022': 413, '6-2022': 444, '7-2022': 419, '8-2022': 436, '9-2022': 478, '10-2022': 555, '11-2022': 493, '12-2022': 204}
# total: 20395


# cilk
# {'1-2012': 3, '3-2012': 1, '4-2012': 2, '5-2012': 1, '6-2012': 1, '7-2012': 0, '8-2012': 0, '9-2012': 3, '10-2012': 1, '11-2012': 3, '12-2012': 1, '1-2013': 7, '2-2013': 1, '3-2013': 1, '4-2013': 2, '5-2013': 0, '6-2013': 2, '7-2013': 0, '8-2013': 1, '9-2013': 0, '10-2013': 0, '11-2013': 3, '12-2013': 3, '1-2014': 1, '2-2014': 2, '3-2014': 2, '4-2014': 2, '5-2014': 1, '6-2014': 1, '7-2014': 1, '8-2014': 0, '9-2014': 5, '10-2014': 2, '11-2014': 2, '12-2014': 1, '1-2015': 1, '2-2015': 2, '3-2015': 8, '4-2015': 3, '5-2015': 1, '6-2015': 2, '7-2015': 1, '8-2015': 3, '9-2015': 1, '10-2015': 0, '11-2015': 1, '12-2015': 2, '1-2016': 3, '2-2016': 3, '3-2016': 2, '4-2016': 1, '5-2016': 3, '6-2016': 0, '7-2016': 0, '8-2016': 0, '9-2016': 1, '10-2016': 2, '11-2016': 2, '12-2016': 1, '1-2017': 0, '2-2017': 1, '3-2017': 2, '4-2017': 2, '5-2017': 1, '6-2017': 1, '7-2017': 0, '8-2017': 1, '9-2017': 1, '10-2017': 4, '11-2017': 6, '12-2017': 1, '1-2018': 2, '2-2018': 5, '3-2018': 7, '4-2018': 1, '5-2018': 1, '6-2018': 1, '7-2018': 1, '8-2018': 2, '9-2018': 1, '10-2018': 1, '11-2018': 2, '12-2018': 2, '1-2019': 3, '2-2019': 1, '3-2019': 2, '4-2019': 4, '5-2019': 4, '6-2019': 1, '7-2019': 1, '8-2019': 2, '9-2019': 0, '10-2019': 9, '11-2019': 1, '12-2019': 3, '1-2020': 5, '2-2020': 4, '3-2020': 2, '4-2020': 2, '5-2020': 3, '6-2020': 2, '7-2020': 1, '8-2020': 0, '9-2020': 0, '10-2020': 1, '11-2020': 3, '12-2020': 0, '1-2021': 1, '2-2021': 1, '3-2021': 2, '4-2021': 0, '5-2021': 5, '6-2021': 0, '7-2021': 2, '8-2021': 0, '9-2021': 2, '10-2021': 1, '11-2021': 4, '12-2021': 0, '1-2022': 0, '2-2022': 1, '3-2022': 0, '4-2022': 1, '5-2022': 1, '6-2022': 0, '7-2022': 2, '8-2022': 0, '9-2022': 1, '10-2022': 1, '11-2022': 4, '12-2022': 1}
# total: 233


# TBB
# {'1-2012': 1, '3-2012': 1, '4-2012': 3, '5-2012': 5, '6-2012': 5, '7-2012': 2, '8-2012': 1, '9-2012': 2, '10-2012': 2, '11-2012': 1, '12-2012': 3, '1-2013': 2, '2-2013': 2, '3-2013': 3, '4-2013': 5, '5-2013': 4, '6-2013': 4, '7-2013': 6, '8-2013': 3, '9-2013': 3, '10-2013': 3, '11-2013': 2, '12-2013': 5, '1-2014': 6, '2-2014': 6, '3-2014': 6, '4-2014': 8, '5-2014': 8, '6-2014': 6, '7-2014': 6, '8-2014': 4, '9-2014': 10, '10-2014': 6, '11-2014': 7, '12-2014': 6, '1-2015': 11, '2-2015': 7, '3-2015': 5, '4-2015': 7, '5-2015': 4, '6-2015': 7, '7-2015': 5, '8-2015': 10, '9-2015': 13, '10-2015': 12, '11-2015': 12, '12-2015': 6, '1-2016': 4, '2-2016': 6, '3-2016': 7, '4-2016': 6, '5-2016': 12, '6-2016': 5, '7-2016': 8, '8-2016': 4, '9-2016': 9, '10-2016': 10, '11-2016': 13, '12-2016': 8, '1-2017': 8, '2-2017': 12, '3-2017': 9, '4-2017': 12, '5-2017': 9, '6-2017': 7, '7-2017': 16, '8-2017': 18, '9-2017': 9, '10-2017': 10, '11-2017': 15, '12-2017': 14, '1-2018': 12, '2-2018': 19, '3-2018': 6, '4-2018': 11, '5-2018': 9, '6-2018': 9, '7-2018': 7, '8-2018': 14, '9-2018': 12, '10-2018': 10, '11-2018': 15, '12-2018': 9, '1-2019': 8, '2-2019': 19, '3-2019': 16, '4-2019': 18, '5-2019': 14, '6-2019': 6, '7-2019': 11, '8-2019': 12, '9-2019': 14, '10-2019': 7, '11-2019': 20, '12-2019': 13, '1-2020': 13, '2-2020': 11, '3-2020': 6, '4-2020': 16, '5-2020': 20, '6-2020': 15, '7-2020': 9, '8-2020': 16, '9-2020': 17, '10-2020': 15, '11-2020': 19, '12-2020': 13, '1-2021': 15, '2-2021': 5, '3-2021': 17, '4-2021': 10, '5-2021': 13, '6-2021': 36, '7-2021': 18, '8-2021': 10, '9-2021': 15, '10-2021': 11, '11-2021': 20, '12-2021': 20, '1-2022': 17, '2-2022': 21, '3-2022': 14, '4-2022': 17, '5-2022': 23, '6-2022': 19, '7-2022': 30, '8-2022': 35, '9-2022': 14, '10-2022': 70, '11-2022': 20, '12-2022': 10}
# total: 1431
